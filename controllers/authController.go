package controllers

import (
	"bytes"
	"ced-paper/CED-Authentication/_const"
	"ced-paper/CED-Authentication/cert"
	"ced-paper/CED-Authentication/contract"
	"ced-paper/CED-Authentication/elliptic/sm9curve"
	"ced-paper/CED-Authentication/sm/sm9"
	"context"
	"crypto/x509"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"github.com/gofrs/uuid"
	"io/ioutil"
	"net/http"
	"net/url"
	"time"
)

type AuthController struct {
	BaseController
}

func (c *AuthController) Test() {
	c.Success(nil, "welcome to authentication")
}

func (c *AuthController) CaAuth() {
	reqUrl := c.Ctx.Request.PostForm.Get("url")
	start := time.Now()
	uuids, _ := uuid.NewV4()
	id := uuids.String()
	ts := time.Now().String()
	mk := sm9.Mk()
	mkBytes, _ := json.Marshal(mk)
	fmt.Println(string(mkBytes))
	enc := sm9.Encrypt(mk.MEncPk, []byte(id+ts), _const.Edge_A, _const.H_Id)
	values := url.Values{}
	values.Add("enc", sm9.EncodeEnc(enc))
	//resp, _ := http.Post("http://localhost:8080/caAuthBack", "application/json", bytes.NewReader(bytesData))
	resp, _ := http.PostForm(reqUrl, values)
	body, _ := ioutil.ReadAll(resp.Body)
	superResult := SuperResult{}
	err := json.Unmarshal(body, &superResult)
	if err != nil {
		c.Error(500, "error", err)
	}
	respData := superResult.Data.(string)
	enc = sm9.DecodeEnc(respData)
	uk1 := sm9.Uk1()
	decRes := sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	res := map[string]string{}
	json.Unmarshal(decRes, &res)
	ellapsed := time.Since(start)
	fmt.Println(res)
	fmt.Println("ellapsed: ", ellapsed.Nanoseconds()/1000000, " ms")
	c.Success(res, "success")
}

func (c *AuthController) CaAuthBack() {
	encStr := c.Ctx.Request.PostForm.Get("enc")
	enc := sm9.DecodeEnc(encStr)
	uk1 := sm9.Uk1()
	result := sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	fmt.Println(string(result))
	gasPrice, _ := contract.Cli.SuggestGasPrice(context.Background())
	s, err := contract.ReadStorage(contract.Cli, contract.AuthCli, contract.Instance, gasPrice, _const.SuggestHighGasLimit)
	if err != nil {
		c.Error(500, "call contract error", err)
		return
	}
	fmt.Println(s)
	certificate, _, _ := cert.GenDCA(string(_const.Edge_A), contract.Certificate, contract.CaSk)
	resData := map[string]string{}
	caBytes, _ := json.Marshal(certificate)
	resData["certificate"] = hex.EncodeToString(caBytes)
	ts := time.Now().String()
	resData["ts"] = ts
	resBytes, _ := json.Marshal(resData)
	mk := sm9.Mk()
	enc = sm9.Encrypt(mk.MEncPk, resBytes, _const.Edge_A, _const.H_Id)
	encStr = sm9.EncodeEnc(enc)
	c.Success(encStr, "CA back")
}

func (c *AuthController) EdgeToCloud() {
	reqUrl1 := c.Ctx.Request.PostForm.Get("url1")
	reqUrl2 := c.Ctx.Request.PostForm.Get("url2")
	gen1, _ := uuid.NewV4()
	gen2, _ := uuid.NewV4()
	idC := gen1.String()
	idE := gen2.String()
	N1 := sm9curve.RandomValue()
	Ce := "7b22526177223a224d494942357a43434159796741774942416749424154414b42676771686b6a4f50515144416a41314d517377435159445651514745774a54525445554d4249474131554543684d4c513239746347467565534244627934784544414f42674e5642414d5442314a7662335167513045774868634e4d6a45774e5441324d446b304e5451775768634e4d7a45774e5441324d446b304e545577576a41304d517377435159445651514745774a54525445554d4249474131554543684d4c51323974634746756553424462793478447a414e42674e5642414d4d426b566b5a3256665154425a4d424d4742797147534d34394167454743437147534d34394177454841304941424f564c7932654f46494b4732504b4a6b374141735a71722b757434316d57484374504134674658544c4444334f3352622b59354c745a6d547a656e4c776e7a33372f53354857566b6e6e35756a5572542f796a585a4b6a6759307767596f7744675944565230504151482f42415144416745474d424d47413155644a51514d4d416f47434373474151554642774d424d42494741315564457745422f7751494d4159424166384341514577485159445652304f42425945464431736a46317948314255702f51684c395776474a6b7355636b354d42384741315564497751594d42614146442f344f317a443856387059344c6b646a3352564f454f474449794d41384741315564455151494d4161484248384141414577436759494b6f5a497a6a3045417749445351417752674968414f684f62686e5643652b39436759657a66666357595357674a4a73476d485837324472627a36786a762f6d41694541312f484a4d30557066704a4367726644666247656453444631383237713167366e6d534955764b714d4d383d222c225261775442534365727469666963617465223a224d4949426a4b414441674543416745424d416f4743437147534d343942414d434d445578437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45514d4134474131554541784d48556d39766443424451544165467730794d5441314d4459774f5451314e4442614677307a4d5441314d4459774f5451314e5442614d445178437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45504d41304741315545417777475257526e5a5639424d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741453555764c5a343455676f6259386f6d54734143786d71763636336a575a59634b303844694156644d734d506337644676356a6b75316d5a504e3663764366506676394c6b645a575365666d364e5374502f4b4e646b714f426a544342696a414f42674e56485138424166384542414d4341515977457759445652306c42417777436759494b775942425155484177457745675944565230544151482f42416777426745422f7749424154416442674e5648513445466751555057794d585849665546536e39434576316138596d53785279546b77487759445652306a42426777466f4155502f6737584d507858796c6a6775523250644655345134594d6a4977447759445652305242416777426f63456677414141513d3d222c225261775375626a6563745075626c69634b6579496e666f223a224d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741453555764c5a343455676f6259386f6d54734143786d71763636336a575a59634b303844694156644d734d506337644676356a6b75316d5a504e3663764366506676394c6b645a575365666d364e5374502f4b4e646b673d3d222c225261775375626a656374223a224d445178437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45504d41304741315545417777475257526e5a563942222c22526177497373756572223a224d445578437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45514d4134474131554541784d48556d39766443424451513d3d222c225369676e6174757265223a224d4559434951446f546d345a31516e7676516f474873333333466d456c6f435362427068312b39673632382b7359372f35674968414e667879544e464b583653516f4b33773332786e6e55677864664e753674594f70356b69464c79716a4450222c225369676e6174757265416c676f726974686d223a31302c225075626c69634b6579416c676f726974686d223a332c225075626c69634b6579223a7b224375727665223a7b2250223a3131353739323038393231303335363234383736323639373434363934393430373537333533303038363134333431353239303331343139353533333633313330383836373039373835333935312c224e223a3131353739323038393231303335363234383736323639373434363934393430373537333532393939363935353232343133353736303334323432323235393036313036383531323034343336392c2242223a34313035383336333732353135323134323132393332363132393738303034373236383430393131343434313031353939333732353535343833353235363331343033393436373430313239312c224778223a34383433393536313239333930363435313735393035323538353235323739373931343230323736323934393532363034313734373939353834343038303731373038323430343633353238362c224779223a33363133343235303935363734393739353739383538353132373931393538373838313935363631313130363637323938353031353037313837373139383235333536383431343430353130392c2242697453697a65223a3235362c224e616d65223a22502d323536227d2c2258223a3130333731333535393730313737323036393635313239333337353931323033363431393231333531383734333938363530333132343936333634303130333930353635333037303534303939352c2259223a39393932393031343932343435363939323539383436333535353437363136333837333634303137363137363132313330353530323137343435383231343036373532313536373534363737307d2c2256657273696f6e223a332c2253657269616c4e756d626572223a312c22497373756572223a7b22436f756e747279223a5b225345225d2c224f7267616e697a6174696f6e223a5b22436f6d70616e7920436f2e225d2c224f7267616e697a6174696f6e616c556e6974223a6e756c6c2c224c6f63616c697479223a6e756c6c2c2250726f76696e6365223a6e756c6c2c2253747265657441646472657373223a6e756c6c2c22506f7374616c436f6465223a6e756c6c2c2253657269616c4e756d626572223a22222c22436f6d6d6f6e4e616d65223a22526f6f74204341222c224e616d6573223a5b7b2254797065223a5b322c352c342c365d2c2256616c7565223a225345227d2c7b2254797065223a5b322c352c342c31305d2c2256616c7565223a22436f6d70616e7920436f2e227d2c7b2254797065223a5b322c352c342c335d2c2256616c7565223a22526f6f74204341227d5d2c2245787472614e616d6573223a6e756c6c7d2c225375626a656374223a7b22436f756e747279223a5b225345225d2c224f7267616e697a6174696f6e223a5b22436f6d70616e7920436f2e225d2c224f7267616e697a6174696f6e616c556e6974223a6e756c6c2c224c6f63616c697479223a6e756c6c2c2250726f76696e6365223a6e756c6c2c2253747265657441646472657373223a6e756c6c2c22506f7374616c436f6465223a6e756c6c2c2253657269616c4e756d626572223a22222c22436f6d6d6f6e4e616d65223a22456467655f41222c224e616d6573223a5b7b2254797065223a5b322c352c342c365d2c2256616c7565223a225345227d2c7b2254797065223a5b322c352c342c31305d2c2256616c7565223a22436f6d70616e7920436f2e227d2c7b2254797065223a5b322c352c342c335d2c2256616c7565223a22456467655f41227d5d2c2245787472614e616d6573223a6e756c6c7d2c224e6f744265666f7265223a22323032312d30352d30365430393a34353a34305a222c224e6f744166746572223a22323033312d30352d30365430393a34353a35305a222c224b65795573616765223a39362c22457874656e73696f6e73223a5b7b224964223a5b322c352c32392c31355d2c22437269746963616c223a747275652c2256616c7565223a224177494242673d3d227d2c7b224964223a5b322c352c32392c33375d2c22437269746963616c223a66616c73652c2256616c7565223a224d416f47434373474151554642774d42227d2c7b224964223a5b322c352c32392c31395d2c22437269746963616c223a747275652c2256616c7565223a224d415942416638434151453d227d2c7b224964223a5b322c352c32392c31345d2c22437269746963616c223a66616c73652c2256616c7565223a22424251396249786463683951564b663049532f567278695a4c46484a4f513d3d227d2c7b224964223a5b322c352c32392c33355d2c22437269746963616c223a66616c73652c2256616c7565223a224d42614146442f344f317a443856387059344c6b646a3352564f454f47444979227d2c7b224964223a5b322c352c32392c31375d2c22437269746963616c223a66616c73652c2256616c7565223a224d416148424838414141453d227d5d2c224578747261457874656e73696f6e73223a6e756c6c2c22556e68616e646c6564437269746963616c457874656e73696f6e73223a6e756c6c2c224578744b65795573616765223a5b315d2c22556e6b6e6f776e4578744b65795573616765223a6e756c6c2c224261736963436f6e73747261696e747356616c6964223a747275652c2249734341223a747275652c224d6178506174684c656e223a312c224d6178506174684c656e5a65726f223a66616c73652c225375626a6563744b65794964223a225057794d585849665546536e39434576316138596d53785279546b3d222c22417574686f726974794b65794964223a22502f6737584d507858796c6a6775523250644655345134594d6a493d222c224f435350536572766572223a6e756c6c2c2249737375696e67436572746966696361746555524c223a6e756c6c2c22444e534e616d6573223a6e756c6c2c22456d61696c416464726573736573223a6e756c6c2c224950416464726573736573223a5b223132372e302e302e31225d2c2255524973223a6e756c6c2c225065726d6974746564444e53446f6d61696e73437269746963616c223a66616c73652c225065726d6974746564444e53446f6d61696e73223a6e756c6c2c224578636c75646564444e53446f6d61696e73223a6e756c6c2c225065726d6974746564495052616e676573223a6e756c6c2c224578636c75646564495052616e676573223a6e756c6c2c225065726d6974746564456d61696c416464726573736573223a6e756c6c2c224578636c75646564456d61696c416464726573736573223a6e756c6c2c225065726d6974746564555249446f6d61696e73223a6e756c6c2c224578636c75646564555249446f6d61696e73223a6e756c6c2c2243524c446973747269627574696f6e506f696e7473223a6e756c6c2c22506f6c6963794964656e74696669657273223a6e756c6c7d"
	ts := time.Now().String()
	var buf bytes.Buffer
	buf.WriteString(idE)
	buf.WriteString(idC)
	buf.WriteString(N1.String())
	buf.WriteString(Ce)
	buf.WriteString(ts)
	mk := sm9.Mk()
	enc := sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	values := url.Values{}
	values.Add("enc", sm9.EncodeEnc(enc))
	//resp, _ := http.Post("http://localhost:8080/caAuthBack", "application/json", bytes.NewReader(bytesData))
	resp, _ := http.PostForm(reqUrl1, values)
	body, _ := ioutil.ReadAll(resp.Body)
	superResult := SuperResult{}
	err := json.Unmarshal(body, &superResult)
	if err != nil {
		c.Error(500, "error", err)
	}
	respData := superResult.Data.(string)
	enc = sm9.DecodeEnc(respData)
	uk1 := sm9.Uk1()
	M4 := sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	fmt.Println(string(M4))
	gasPrice, _ := contract.Cli.SuggestGasPrice(context.Background())
	s, err := contract.ReadStorage(contract.Cli, contract.AuthCli, contract.Instance, gasPrice, _const.SuggestHighGasLimit)
	if err != nil {
		c.Error(500, "call contract error", err)
		return
	}
	fmt.Println(s)
	a := sm9curve.RandomValue()
	b := sm9curve.RandomValue()
	A := new(sm9curve.G1).ScalarBaseMult(a)
	new(sm9curve.G1).ScalarMult(A, b)
	buf.Reset()
	buf.WriteString(idC)
	buf.WriteString(idE)
	buf.Write(a.Bytes())
	buf.Write(b.Bytes())
	buf.Write(A.Marshal())
	n3 := sm9curve.RandomValue()
	ts5 := time.Now().String()
	enc = sm9.Encrypt(mk.MEncPk, n3.Bytes(), _const.Edge_A, _const.H_Id)
	encStr := sm9.EncodeEnc(enc)
	buf.WriteString(encStr)
	buf.WriteString(ts5)
	M5 := sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	res := map[string]string{}
	res["other"] = sm9.EncodeEnc(M5)
	res["enc"] = encStr
	values = url.Values{}
	resBytes, _ := json.Marshal(res)
	values.Add("enc", hex.EncodeToString(resBytes))
	//resp, _ := http.Post("http://localhost:8080/caAuthBack", "application/json", bytes.NewReader(bytesData))
	resp, _ = http.PostForm(reqUrl2, values)
	body, _ = ioutil.ReadAll(resp.Body)
	superResult = SuperResult{}
	err = json.Unmarshal(body, &superResult)
	if err != nil {
		c.Error(500, "error", err)
	}
	respData = superResult.Data.(string)

}

func (c *AuthController) EdgeToCloudBack1() {
	encStr := c.Ctx.Request.PostForm.Get("enc")
	enc := sm9.DecodeEnc(encStr)
	uk1 := sm9.Uk1()
	M3 := sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	fmt.Println(string(M3))
	caStr := "7b22526177223a224d494942357a43434159796741774942416749424154414b42676771686b6a4f50515144416a41314d517377435159445651514745774a54525445554d4249474131554543684d4c513239746347467565534244627934784544414f42674e5642414d5442314a7662335167513045774868634e4d6a45774e5441324d446b304e5451775768634e4d7a45774e5441324d446b304e545577576a41304d517377435159445651514745774a54525445554d4249474131554543684d4c51323974634746756553424462793478447a414e42674e5642414d4d426b566b5a3256665154425a4d424d4742797147534d34394167454743437147534d34394177454841304941424f564c7932654f46494b4732504b4a6b374141735a71722b757434316d57484374504134674658544c4444334f3352622b59354c745a6d547a656e4c776e7a33372f53354857566b6e6e35756a5572542f796a585a4b6a6759307767596f7744675944565230504151482f42415144416745474d424d47413155644a51514d4d416f47434373474151554642774d424d42494741315564457745422f7751494d4159424166384341514577485159445652304f42425945464431736a46317948314255702f51684c395776474a6b7355636b354d42384741315564497751594d42614146442f344f317a443856387059344c6b646a3352564f454f474449794d41384741315564455151494d4161484248384141414577436759494b6f5a497a6a3045417749445351417752674968414f684f62686e5643652b39436759657a66666357595357674a4a73476d485837324472627a36786a762f6d41694541312f484a4d30557066704a4367726644666247656453444631383237713167366e6d534955764b714d4d383d222c225261775442534365727469666963617465223a224d4949426a4b414441674543416745424d416f4743437147534d343942414d434d445578437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45514d4134474131554541784d48556d39766443424451544165467730794d5441314d4459774f5451314e4442614677307a4d5441314d4459774f5451314e5442614d445178437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45504d41304741315545417777475257526e5a5639424d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741453555764c5a343455676f6259386f6d54734143786d71763636336a575a59634b303844694156644d734d506337644676356a6b75316d5a504e3663764366506676394c6b645a575365666d364e5374502f4b4e646b714f426a544342696a414f42674e56485138424166384542414d4341515977457759445652306c42417777436759494b775942425155484177457745675944565230544151482f42416777426745422f7749424154416442674e5648513445466751555057794d585849665546536e39434576316138596d53785279546b77487759445652306a42426777466f4155502f6737584d507858796c6a6775523250644655345134594d6a4977447759445652305242416777426f63456677414141513d3d222c225261775375626a6563745075626c69634b6579496e666f223a224d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741453555764c5a343455676f6259386f6d54734143786d71763636336a575a59634b303844694156644d734d506337644676356a6b75316d5a504e3663764366506676394c6b645a575365666d364e5374502f4b4e646b673d3d222c225261775375626a656374223a224d445178437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45504d41304741315545417777475257526e5a563942222c22526177497373756572223a224d445578437a414a42674e5642415954416c4e464d525177456759445651514b45777444623231775957353549454e764c6a45514d4134474131554541784d48556d39766443424451513d3d222c225369676e6174757265223a224d4559434951446f546d345a31516e7676516f474873333333466d456c6f435362427068312b39673632382b7359372f35674968414e667879544e464b583653516f4b33773332786e6e55677864664e753674594f70356b69464c79716a4450222c225369676e6174757265416c676f726974686d223a31302c225075626c69634b6579416c676f726974686d223a332c225075626c69634b6579223a7b224375727665223a7b2250223a3131353739323038393231303335363234383736323639373434363934393430373537333533303038363134333431353239303331343139353533333633313330383836373039373835333935312c224e223a3131353739323038393231303335363234383736323639373434363934393430373537333532393939363935353232343133353736303334323432323235393036313036383531323034343336392c2242223a34313035383336333732353135323134323132393332363132393738303034373236383430393131343434313031353939333732353535343833353235363331343033393436373430313239312c224778223a34383433393536313239333930363435313735393035323538353235323739373931343230323736323934393532363034313734373939353834343038303731373038323430343633353238362c224779223a33363133343235303935363734393739353739383538353132373931393538373838313935363631313130363637323938353031353037313837373139383235333536383431343430353130392c2242697453697a65223a3235362c224e616d65223a22502d323536227d2c2258223a3130333731333535393730313737323036393635313239333337353931323033363431393231333531383734333938363530333132343936333634303130333930353635333037303534303939352c2259223a39393932393031343932343435363939323539383436333535353437363136333837333634303137363137363132313330353530323137343435383231343036373532313536373534363737307d2c2256657273696f6e223a332c2253657269616c4e756d626572223a312c22497373756572223a7b22436f756e747279223a5b225345225d2c224f7267616e697a6174696f6e223a5b22436f6d70616e7920436f2e225d2c224f7267616e697a6174696f6e616c556e6974223a6e756c6c2c224c6f63616c697479223a6e756c6c2c2250726f76696e6365223a6e756c6c2c2253747265657441646472657373223a6e756c6c2c22506f7374616c436f6465223a6e756c6c2c2253657269616c4e756d626572223a22222c22436f6d6d6f6e4e616d65223a22526f6f74204341222c224e616d6573223a5b7b2254797065223a5b322c352c342c365d2c2256616c7565223a225345227d2c7b2254797065223a5b322c352c342c31305d2c2256616c7565223a22436f6d70616e7920436f2e227d2c7b2254797065223a5b322c352c342c335d2c2256616c7565223a22526f6f74204341227d5d2c2245787472614e616d6573223a6e756c6c7d2c225375626a656374223a7b22436f756e747279223a5b225345225d2c224f7267616e697a6174696f6e223a5b22436f6d70616e7920436f2e225d2c224f7267616e697a6174696f6e616c556e6974223a6e756c6c2c224c6f63616c697479223a6e756c6c2c2250726f76696e6365223a6e756c6c2c2253747265657441646472657373223a6e756c6c2c22506f7374616c436f6465223a6e756c6c2c2253657269616c4e756d626572223a22222c22436f6d6d6f6e4e616d65223a22456467655f41222c224e616d6573223a5b7b2254797065223a5b322c352c342c365d2c2256616c7565223a225345227d2c7b2254797065223a5b322c352c342c31305d2c2256616c7565223a22436f6d70616e7920436f2e227d2c7b2254797065223a5b322c352c342c335d2c2256616c7565223a22456467655f41227d5d2c2245787472614e616d6573223a6e756c6c7d2c224e6f744265666f7265223a22323032312d30352d30365430393a34353a34305a222c224e6f744166746572223a22323033312d30352d30365430393a34353a35305a222c224b65795573616765223a39362c22457874656e73696f6e73223a5b7b224964223a5b322c352c32392c31355d2c22437269746963616c223a747275652c2256616c7565223a224177494242673d3d227d2c7b224964223a5b322c352c32392c33375d2c22437269746963616c223a66616c73652c2256616c7565223a224d416f47434373474151554642774d42227d2c7b224964223a5b322c352c32392c31395d2c22437269746963616c223a747275652c2256616c7565223a224d415942416638434151453d227d2c7b224964223a5b322c352c32392c31345d2c22437269746963616c223a66616c73652c2256616c7565223a22424251396249786463683951564b663049532f567278695a4c46484a4f513d3d227d2c7b224964223a5b322c352c32392c33355d2c22437269746963616c223a66616c73652c2256616c7565223a224d42614146442f344f317a443856387059344c6b646a3352564f454f47444979227d2c7b224964223a5b322c352c32392c31375d2c22437269746963616c223a66616c73652c2256616c7565223a224d416148424838414141453d227d5d2c224578747261457874656e73696f6e73223a6e756c6c2c22556e68616e646c6564437269746963616c457874656e73696f6e73223a6e756c6c2c224578744b65795573616765223a5b315d2c22556e6b6e6f776e4578744b65795573616765223a6e756c6c2c224261736963436f6e73747261696e747356616c6964223a747275652c2249734341223a747275652c224d6178506174684c656e223a312c224d6178506174684c656e5a65726f223a66616c73652c225375626a6563744b65794964223a225057794d585849665546536e39434576316138596d53785279546b3d222c22417574686f726974794b65794964223a22502f6737584d507858796c6a6775523250644655345134594d6a493d222c224f435350536572766572223a6e756c6c2c2249737375696e67436572746966696361746555524c223a6e756c6c2c22444e534e616d6573223a6e756c6c2c22456d61696c416464726573736573223a6e756c6c2c224950416464726573736573223a5b223132372e302e302e31225d2c2255524973223a6e756c6c2c225065726d6974746564444e53446f6d61696e73437269746963616c223a66616c73652c225065726d6974746564444e53446f6d61696e73223a6e756c6c2c224578636c75646564444e53446f6d61696e73223a6e756c6c2c225065726d6974746564495052616e676573223a6e756c6c2c224578636c75646564495052616e676573223a6e756c6c2c225065726d6974746564456d61696c416464726573736573223a6e756c6c2c224578636c75646564456d61696c416464726573736573223a6e756c6c2c225065726d6974746564555249446f6d61696e73223a6e756c6c2c224578636c75646564555249446f6d61696e73223a6e756c6c2c2243524c446973747269627574696f6e506f696e7473223a6e756c6c2c22506f6c6963794964656e74696669657273223a6e756c6c7d"
	caBytes, _ := hex.DecodeString(caStr)
	var ca *x509.Certificate
	err := json.Unmarshal(caBytes, &ca)
	if err != nil {
		c.Error(500, "json unmarshal error", err)
		return
	}
	gasPrice, _ := contract.Cli.SuggestGasPrice(context.Background())
	s, err := contract.ReadStorage(contract.Cli, contract.AuthCli, contract.Instance, gasPrice, _const.SuggestHighGasLimit)
	if err != nil {
		c.Error(500, "call contract error", err)
		return
	}
	fmt.Println(s)
	verifyDCA := cert.VerifyDCA(contract.Certificate, ca)
	fmt.Println(verifyDCA)
	idC := "f0622183-dd0f-4d4c-b4b3-0b2c6f462c04"
	idE := "83dda2fc-e9ec-4254-a484-8dac67d34f0f"
	n1 := sm9curve.RandomValue()
	n2 := sm9curve.RandomValue()
	nC := sm9curve.RandomValue()
	GNc := new(sm9curve.G1).ScalarBaseMult(nC)
	CcBytes, _ := json.Marshal(contract.Certificate)
	var buf bytes.Buffer
	buf.WriteString(idE)
	buf.WriteString(idC)
	buf.Write(n1.Bytes())
	buf.Write(n2.Bytes())
	buf.Write(GNc.Marshal())
	buf.Write(CcBytes)
	mk := sm9.Mk()
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	encStr = sm9.EncodeEnc(enc)
	c.Success(encStr, "EdgeToCloudBack1 back")
}

func (c *AuthController) EdgeToCloudBack2() {

}

func (c *AuthController) TimeTest() {
	mk := sm9.Mk()
	uk1 := sm9.Uk1()
	t1 := time.Now()
	uuids, _ := uuid.NewV4()
	e1 := time.Since(t1)
	fmt.Println("生成uuid时间: ", e1)
	id := uuids.String()
	var buf bytes.Buffer
	buf.WriteString(id)
	// 1
	t2 := time.Now()
	enc := sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e2 := time.Since(t2)
	fmt.Println("enc 1: ", e2)
	t3 := time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e3 := time.Since(t3)
	fmt.Println("dec 1: ", e3)
	// 2
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 2: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 2: ", e2)
	// 3
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 3: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 3: ", e2)
	// 4
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 4: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 4: ", e2)
	// 5
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 5: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 5: ", e2)
	// 6
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 6: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 6: ", e2)
	// 7
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 7: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 7: ", e2)
	// 8
	t1 = time.Now()
	buf.WriteString(id)
	enc = sm9.Encrypt(mk.MEncPk, buf.Bytes(), _const.Edge_A, _const.H_Id)
	e1 = time.Since(t1)
	fmt.Println("enc 8: ", e1)
	t2 = time.Now()
	sm9.Decrypt(enc, _const.Edge_A, uk1.EncSk)
	e2 = time.Since(t2)
	fmt.Println("dec 8: ", e2)
	// scalar base
	t1 = time.Now()
	r := sm9curve.RandomValue()
	A := new(sm9curve.G1).ScalarBaseMult(r)
	e1 = time.Since(t1)
	fmt.Println("g1 ScalarBaseMult: ", e1)
	// scalar mult
	t1 = time.Now()
	B := new(sm9curve.G1).ScalarMult(A, r)
	e1 = time.Since(t1)
	fmt.Println("g1 ScalarMult: ", e1)
	// g1 add
	t1 = time.Now()
	new(sm9curve.G1).Add(A, B)
	e1 = time.Since(t1)
	fmt.Println("g1 add: ", e1)
	// generate ca
	t1 = time.Now()
	certificate, _, _ := cert.GenDCA("test", contract.Certificate, contract.CaSk)
	e1 = time.Since(t1)
	fmt.Println("gen dca: ", e1)
	// verify ca
	t1 = time.Now()
	cert.VerifyDCA(contract.Certificate, certificate)
	e1 = time.Since(t1)
	fmt.Println("verify dca: ", e1)
	// read chain
	t1 = time.Now()
	gasPrice, _ := contract.Cli.SuggestGasPrice(context.Background())
	contract.ReadStorage(contract.Cli, contract.AuthCli, contract.Instance, gasPrice, _const.SuggestHighGasLimit)
	e1 = time.Since(t1)
	fmt.Println("read chain: ", e1)
	// write chain
	t1 = time.Now()
	contract.Store(contract.Cli, contract.AuthCli, contract.Instance, id, gasPrice, _const.SuggestHighGasLimit)
	e1 = time.Since(t1)
	fmt.Println("write chain: ", e1)
	c.Success(nil, "success")
}
